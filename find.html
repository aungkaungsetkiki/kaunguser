<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Ledger - Multi-Ledger Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            color: #1a2a6c;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #b21f1f;
            font-size: 1.2rem;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .ledger-list {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .summary-section {
            flex: 2;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 10;
        }
        
        h2 {
            color: #1a2a6c;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #b21f1f;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        th {
            background-color: #1a2a6c;
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        tr:hover {
            background-color: #e6f7ff;
        }
        
        .ledger-row {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .ledger-row:hover {
            background-color: #d1ecff;
            transform: translateY(-2px);
        }
        
        .selected-ledger {
            background-color: #cce5ff !important;
            font-weight: bold;
        }
        
        .pnumber-input {
            width: 50px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .save-btn {
            padding: 5px 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .save-btn:hover {
            background-color: #218838;
        }
        
        .select-btn {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .select-btn.purple {
            background-color: #800080;
        }
        
        .select-btn:hover {
            background-color: #0069d9;
        }
        
        .select-btn.purple:hover {
            background-color: #6a006a;
        }
        
        .combine-btn {
            padding: 10px 20px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
        }
        
        .combine-btn:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        
        .back-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 25px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .name-group {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .name-header {
            background-color: #1a2a6c;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .ledger-row-detail {
            background-color: #f8f9fa;
        }
        
        .ledger-row-detail:hover {
            background-color: #e2e6ea;
        }
        
        .group-footer {
            background-color: #e9ecef;
            font-weight: bold;
        }
        
        .profit {
            color: #28a745;
            font-weight: bold;
        }
        
        .loss {
            color: #dc3545;
            font-weight: bold;
        }
        
        .total-footer {
            background-color: #343a40;
            color: white;
            font-weight: bold;
        }
        
        .no-data {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
        
        .date-display {
            background-color: #b21f1f;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2rem;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        .pnumber-display {
            background-color: #1a2a6c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2rem;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }
        
        .checkbox-container input {
            margin-right: 5px;
            transform: scale(1.3);
        }
        
        .combine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .resizable {
            resize: both;
            overflow: auto;
            min-height: 300px;
            min-width: 500px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>2D Ledger Management System</h1>
            <p class="subtitle">Multi-Ledger Summary Viewer</p>
        </header>
        
        <div class="main-content">
            <div class="ledger-list">
                <div class="combine-header">
                    <h2>Saved Ledgers</h2>
                    <button class="combine-btn" onclick="showCombinedSummary()">
                        Show Combined Summary
                    </button>
                </div>
                <table id="ledgers-table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Date & Time</th>
                            <th>PNumber</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ledgers-body">
                        <!-- Ledgers will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <div class="summary-section">
                <div class="summary-header">
                    <h2>Ledger Summary</h2>
                    <div class="summary-controls">
                        <div class="checkbox-container">
                            <input type="checkbox" id="resizable-toggle" checked>
                            <label for="resizable-toggle">Resizable Panel</label>
                        </div>
                    </div>
                </div>
                <div id="summary-display" class="resizable">
                    <!-- Summary will be displayed here -->
                    <div class="no-data">Select ledgers and click "Show Combined Summary"</div>
                </div>
            </div>
        </div>
        
        <button class="back-btn" onclick="window.location.href='index.html'">Back to Main</button>
    </div>

  <script>
    // Load all ledgers on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAllLedgers();
        
        // Make summary panel resizable
        const resizable = document.querySelector('.resizable');
        const toggle = document.getElementById('resizable-toggle');
        
        toggle.addEventListener('change', function() {
            if (this.checked) {
                resizable.style.resize = 'both';
            } else {
                resizable.style.resize = 'none';
            }
        });
    });
    
    // Load all ledger keys from localStorage
    function loadAllLedgers() {
        const ledgersBody = document.getElementById('ledgers-body');
        ledgersBody.innerHTML = '';
        
        // Get all keys from localStorage
        const keys = Object.keys(localStorage);
        
        // Filter keys that start with 'ledger_'
        const ledgerKeys = keys.filter(key => key.startsWith('ledger_'));
        
        if (ledgerKeys.length === 0) {
            ledgersBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No saved ledgers found</td></tr>';
            return;
        }
        
        // Sort ledgers by date/time in descending order (newest first)
        ledgerKeys.sort((a, b) => {
            // Extract date and time parts
            const [_, aDate, aTime] = a.split('_');
            const [__, bDate, bTime] = b.split('_');
            
            // Compare dates first
            if (aDate !== bDate) {
                // Split dates into day, month, year
                const [aDay, aMonth, aYear] = aDate.split('-');
                const [bDay, bMonth, bYear] = bDate.split('-');
                
                // Create Date objects for comparison
                const aDateObj = new Date(`${aYear}-${aMonth}-${aDay}`);
                const bDateObj = new Date(`${bYear}-${bMonth}-${bDay}`);
                
                return bDateObj - aDateObj;
            }
            
            // If dates are equal, compare time (AM/PM)
            if (aTime === 'PM' && bTime === 'AM') return -1;
            if (aTime === 'AM' && bTime === 'PM') return 1;
            return 0;
        });
        
        // Auto-delete oldest ledgers if count exceeds 50
        if (ledgerKeys.length > 50) {
            const ledgersToDelete = ledgerKeys.slice(50);
            ledgersToDelete.forEach(key => localStorage.removeItem(key));
            ledgerKeys.length = 50;
        }
        
        // Process each ledger key
        ledgerKeys.forEach((key, index) => {
            try {
                const ledgerData = JSON.parse(localStorage.getItem(key));
                const [_, date, time] = key.split('_');
                const pnumber = ledgerData.savedPNumber || '';
                
                // Create table row
                const row = document.createElement('tr');
                row.className = 'ledger-row';
                row.dataset.key = key;
                
                // Determine if this row is beyond 10 (for purple button)
                const isBeyond10 = index >= 10;
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="ledger-checkbox">
                    </td>
                    <td>${date} / ${time}</td>
                    <td>
                        ${pnumber ? pnumber : 
                            `<input type="number" class="pnumber-input" min="0" max="99" placeholder="00" 
                             oninput="this.value = this.value.slice(0, 2).padStart(2, '0')">
                             <button class="save-btn" onclick="savePnumber('${key}', this)">Save</button>`}
                    </td>
                    <td>
                        <button class="select-btn ${isBeyond10 ? 'purple' : ''}" onclick="selectLedger('${key}')">View</button>
                    </td>
                `;
                
                ledgersBody.appendChild(row);
            } catch (e) {
                console.error('Error parsing ledger data for key:', key, e);
            }
        });
    }
    
    // Save PNumber for a ledger
    function savePnumber(key, button) {
        const row = button.closest('tr');
        const input = row.querySelector('.pnumber-input');
        const pnumber = input.value.padStart(2, '0');
        
        if (!pnumber || pnumber.length !== 2 || isNaN(pnumber)) {
            alert('Please enter a valid 2-digit number');
            return;
        }
        
        try {
            const ledgerData = JSON.parse(localStorage.getItem(key));
            ledgerData.savedPNumber = pnumber;
            localStorage.setItem(key, JSON.stringify(ledgerData));
            
            // Update UI
            row.cells[2].innerHTML = pnumber;
            
            // If this ledger was selected, reload summary
            const selectedRow = document.querySelector('.ledger-row.selected-ledger');
            if (selectedRow && selectedRow.dataset.key === key) {
                showLedgerSummary(key);
            }
        } catch (e) {
            console.error('Error updating PNumber for key:', key, e);
            alert('Error saving PNumber. Please try again.');
        }
    }
    
    // Select a ledger to view summary
    function selectLedger(key) {
        // Remove previous selection
        document.querySelectorAll('.ledger-row').forEach(row => {
            row.classList.remove('selected-ledger');
        });
        
        // Add selection to current row
        const row = document.querySelector(`.ledger-row[data-key="${key}"]`);
        if (row) {
            row.classList.add('selected-ledger');
        }
        
        // Show ledger summary
        showLedgerSummary(key);
    }
    
    // Show ledger summary
    function showLedgerSummary(key) {
        try {
            const ledgerData = JSON.parse(localStorage.getItem(key));
            const [_, date, time] = key.split('_');
            const pnumber = ledgerData.savedPNumber || '';
            
            // Create summary display
            const summaryDisplay = document.getElementById('summary-display');
            summaryDisplay.innerHTML = `
                <div class="date-display">Date: ${date} / Time: ${time}</div>
                <div class="pnumber-display">PNumber: ${pnumber || 'Not set'}</div>
                <div id="name-summaries"></div>
            `;
            
            // Calculate and display name summaries
            calculateNameSummaries(ledgerData, pnumber);
        } catch (e) {
            console.error('Error showing ledger summary for key:', key, e);
            document.getElementById('summary-display').innerHTML = `
                <div class="no-data">Error loading ledger data</div>
            `;
        }
    }
    
    // Calculate name summaries for a single ledger
    function calculateNameSummaries(ledgerData, pnumber) {
        const nameSummaries = {};
        const nameSummariesContainer = document.getElementById('name-summaries');
        nameSummariesContainer.innerHTML = '';
            // Process main list data
        if (ledgerData.numberMoneyData) {
            ledgerData.numberMoneyData.forEach(item => {
                const name = item.name || 'Unknown';
                if (!nameSummaries[name]) {
                    nameSummaries[name] = {
                        nameTotalMoney: 0,
                        pmoney: 0
                    };
                }
                nameSummaries[name].nameTotalMoney += parseInt(item.money);
                
                // Check if this is the pnumber entry
                if (pnumber && item.number === pnumber) {
                    nameSummaries[name].pmoney += parseInt(item.money);
                }
            });
        }
        
        // Process DI list data (subtract from totals)
        if (ledgerData.diNumberMoneyData) {
            ledgerData.diNumberMoneyData.forEach(item => {
                const name = item.name || 'Unknown';
                if (!nameSummaries[name]) {
                    nameSummaries[name] = {
                        nameTotalMoney: 0,
                        pmoney: 0
                    };
                }
                nameSummaries[name].nameTotalMoney -= parseInt(item.money);
                
                // Check if this is the pnumber entry
                if (pnumber && item.number === pnumber) {
                    nameSummaries[name].pmoney -= parseInt(item.money);
                }
            });
        }
        
        // Sort ledgers by date/time in descending order (newest first)
        const sortedNames = Object.keys(nameSummaries).sort((a, b) => {
            // Custom sorting logic if needed
            return a.localeCompare(b);
        });
        
        // Create summary for each name
        for (const name of sortedNames) {
            const commission = 15; // Fixed 15%
            const multiplier = 80; // Fixed 80
            
            const nameTotalMoney = nameSummaries[name].nameTotalMoney;
            const pmoney = nameSummaries[name].pmoney;
            
            // Calculate commission amount
            const commissionAmount = (nameTotalMoney * commission) / 100;
            
            // Calculate result
            const result = nameTotalMoney - commissionAmount - (pmoney * multiplier);
            
            // Create name group container
            const nameGroup = document.createElement('div');
            nameGroup.className = 'name-group';
            
            // Name header
            const nameHeader = document.createElement('div');
            nameHeader.className = 'name-header';
            nameHeader.textContent = name;
            nameGroup.appendChild(nameHeader);
            
            // Create table for this name
            const table = document.createElement('table');
            
            // Table header
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Name Total Money</th>
                    <th>P Money</th>
                    <th>Commission (15%)</th>
                    <th>Multiple (80)</th>
                    <th>Total</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // Table body
            const tbody = document.createElement('tbody');
            tbody.innerHTML = `
                <tr class="ledger-row-detail">
                    <td>${nameTotalMoney.toLocaleString()}</td>
                    <td>${pmoney.toLocaleString()}</td>
                    <td>${commissionAmount.toLocaleString()}</td>
                    <td>${(pmoney * multiplier).toLocaleString()}</td>
                    <td class="${result >= 0 ? 'profit' : 'loss'}">${result.toLocaleString()}</td>
                </tr>
            `;
            table.appendChild(tbody);
            
            nameGroup.appendChild(table);
            nameSummariesContainer.appendChild(nameGroup);
        }
    }

    // Modified loadAllLedgers function to implement sorting and row styling
    function loadAllLedgers() {
        const ledgersBody = document.getElementById('ledgers-body');
        ledgersBody.innerHTML = '';
        
        // Get all keys from localStorage
        const keys = Object.keys(localStorage);
        
        // Filter keys that start with 'ledger_'
        const ledgerKeys = keys.filter(key => key.startsWith('ledger_'));
        
        if (ledgerKeys.length === 0) {
            ledgersBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No saved ledgers found</td></tr>';
            return;
        }
        
        // Sort ledgers by date/time in descending order (newest first)
        const sortedLedgerKeys = ledgerKeys.sort((a, b) => {
            const [_, aDate, aTime] = a.split('_');
            const [__, bDate, bTime] = b.split('_');
            
            // First compare dates
            const dateComparison = bDate.localeCompare(aDate);
            if (dateComparison !== 0) return dateComparison;
            
            // If dates are equal, compare times (PM comes before AM)
            return bTime.localeCompare(aTime);
        });
        
        // Keep only the first 50 ledgers and delete older ones
        if (sortedLedgerKeys.length > 50) {
            const ledgersToDelete = sortedLedgerKeys.slice(50);
            ledgersToDelete.forEach(key => localStorage.removeItem(key));
            sortedLedgerKeys.length = 50;
        }
        
        // Process each ledger key
        sortedLedgerKeys.forEach((key, index) => {
            try {
                const ledgerData = JSON.parse(localStorage.getItem(key));
                const [_, date, time] = key.split('_');
                const pnumber = ledgerData.savedPNumber || '';
                
                // Create table row
                const row = document.createElement('tr');
                row.className = 'ledger-row';
                row.dataset.key = key;
                
                // Change view button color to purple after row 10
                const viewButtonStyle = index >= 10 ? 'style="background-color: #800080;"' : '';
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="ledger-checkbox">
                    </td>
                    <td>${date} / ${time}</td>
                    <td>
                        ${pnumber ? pnumber : 
                            `<input type="number" class="pnumber-input" min="0" max="99" placeholder="00" 
                             oninput="this.value = this.value.slice(0, 2).padStart(2, '0')">
                             <button class="save-btn" onclick="savePnumber('${key}', this)">Save</button>`}
                    </td>
                    <td>
                        <button class="select-btn" ${viewButtonStyle} onclick="selectLedger('${key}')">View</button>
                    </td>
                `;
                
                ledgersBody.appendChild(row);
            } catch (e) {
                console.error('Error parsing ledger data for key:', key, e);
            }
        });
        }

    // Save PNumber for a ledger
    function savePnumber(key, button) {
        const row = button.closest('tr');
        const input = row.querySelector('.pnumber-input');
        const pnumber = input.value.padStart(2, '0');
        
        if (!pnumber || pnumber.length !== 2 || isNaN(pnumber)) {
            alert('Please enter a valid 2-digit number');
            return;
        }
        
        try {
            const ledgerData = JSON.parse(localStorage.getItem(key));
            ledgerData.savedPNumber = pnumber;
            localStorage.setItem(key, JSON.stringify(ledgerData));
            
            // Update UI
            row.cells[2].innerHTML = pnumber;
            
            // If this ledger was selected, reload summary
            const selectedRow = document.querySelector('.ledger-row.selected-ledger');
            if (selectedRow && selectedRow.dataset.key === key) {
                showLedgerSummary(key);
            }
        } catch (e) {
            console.error('Error updating PNumber for key:', key, e);
            alert('Error saving PNumber. Please try again.');
        }
    }
    
    // Select a ledger to view summary
    function selectLedger(key) {
        // Remove previous selection
        document.querySelectorAll('.ledger-row').forEach(row => {
            row.classList.remove('selected-ledger');
        });
        
        // Add selection to current row
        const row = document.querySelector(`.ledger-row[data-key="${key}"]`);
        if (row) {
            row.classList.add('selected-ledger');
        }
        
        // Show ledger summary
        showLedgerSummary(key);
    }
    
    // Show ledger summary
    function showLedgerSummary(key) {
        try {
            const ledgerData = JSON.parse(localStorage.getItem(key));
            const [_, date, time] = key.split('_');
            const pnumber = ledgerData.savedPNumber || '';
            
            // Create summary display
            const summaryDisplay = document.getElementById('summary-display');
            summaryDisplay.innerHTML = `
                <div class="date-display">Date: ${date} / Time: ${time}</div>
                <div class="pnumber-display">PNumber: ${pnumber || 'Not set'}</div>
                <div id="name-summaries"></div>
            `;
            
            // Calculate and display name summaries
            calculateNameSummaries(ledgerData, pnumber);
        } catch (e) {
            console.error('Error showing ledger summary for key:', key, e);
            document.getElementById('summary-display').innerHTML = `
                <div class="no-data">Error loading ledger data</div>
            `;
        }
    }

    // Show combined summary for selected ledgers
    function showCombinedSummary() {
        // Get selected ledger keys
        const selectedKeys = [];
        document.querySelectorAll('.ledger-checkbox:checked').forEach(checkbox => {
            const row = checkbox.closest('tr');
            selectedKeys.push(row.dataset.key);
        });
        
        if (selectedKeys.length === 0) {
            alert('Please select at least one ledger');
            return;
        }
        
        // Sort selected ledgers by date/time (newest first)
        selectedKeys.sort((a, b) => {
            const [_, aDate, aTime] = a.split('_');
            const [__, bDate, bTime] = b.split('_');
            const dateComparison = bDate.localeCompare(aDate);
            return dateComparison !== 0 ? dateComparison : bTime.localeCompare(aTime);
        });
        
        // Create combined summary display
        const summaryDisplay = document.getElementById('summary-display');
        summaryDisplay.innerHTML = `
            <div class="date-display">Combined Summary (${selectedKeys.length} ledgers)</div>
            <div id="combined-summaries"></div>
        `;
        
        // Calculate and display combined summaries
        calculateCombinedSummaries(selectedKeys);
    }
        // Calculate combined summaries for selected ledgers
    function calculateCombinedSummaries(selectedKeys) {
        const combinedSummaries = {};
        const combinedSummariesContainer = document.getElementById('combined-summaries');
        combinedSummariesContainer.innerHTML = '';
        
        // Process each selected ledger
        selectedKeys.forEach(key => {
            try {
                const ledgerData = JSON.parse(localStorage.getItem(key));
                const [_, date, time] = key.split('_');
                const pnumber = ledgerData.savedPNumber || '';
                
                // Process this ledger's data
                processLedgerData(combinedSummaries, key, date, time, pnumber, ledgerData);
                
            } catch (e) {
                console.error('Error processing ledger data for key:', key, e);
            }
        });
        
        // Sort names alphabetically for consistent display
        const sortedNames = Object.keys(combinedSummaries).sort();
        
        // Display combined summaries by name
        for (const name of sortedNames) {
            createNameSummary(combinedSummaries, name, combinedSummariesContainer);
        }
        
        // Add grand totals
        addGrandTotals(combinedSummaries, combinedSummariesContainer);
    }
    
    // Process ledger data for combined summary
    function processLedgerData(combinedSummaries, key, date, time, pnumber, ledgerData) {
        // Initialize temporary object for this ledger
        const ledgerSummary = {};
        
        // Process main list data
        if (ledgerData.numberMoneyData) {
            ledgerData.numberMoneyData.forEach(item => {
                const name = item.name || 'Unknown';
                if (!ledgerSummary[name]) {
                    ledgerSummary[name] = {
                        nameTotalMoney: 0,
                        pmoney: 0
                    };
                }
                ledgerSummary[name].nameTotalMoney += parseInt(item.money);
                
                // Check if this is the pnumber entry
                if (pnumber && item.number === pnumber) {
                    ledgerSummary[name].pmoney += parseInt(item.money);
                }
            });
        }
        
        // Process DI list data (subtract from totals)
        if (ledgerData.diNumberMoneyData) {
            ledgerData.diNumberMoneyData.forEach(item => {
                const name = item.name || 'Unknown';
                if (!ledgerSummary[name]) {
                    ledgerSummary[name] = {
                        nameTotalMoney: 0,
                        pmoney: 0
                    };
                }
                ledgerSummary[name].nameTotalMoney -= parseInt(item.money);
                
                // Check if this is the pnumber entry
                if (pnumber && item.number === pnumber) {
                    ledgerSummary[name].pmoney -= parseInt(item.money);
                }
            });
        }
        
        // Merge into combined summaries
        for (const name in ledgerSummary) {
            if (!combinedSummaries[name]) {
                combinedSummaries[name] = {
                    ledgers: [],
                    totalNameMoney: 0,
                    totalPmoney: 0
                };
            }
            
            // Add ledger entry
            combinedSummaries[name].ledgers.push({
                key: key,
                date: date,
                time: time,
                pnumber: pnumber,
                nameTotalMoney: ledgerSummary[name].nameTotalMoney,
                pmoney: ledgerSummary[name].pmoney
            });
            
            // Update totals
            combinedSummaries[name].totalNameMoney += ledgerSummary[name].nameTotalMoney;
            combinedSummaries[name].totalPmoney += ledgerSummary[name].pmoney;
        }
    }
    
    // Create name summary display
    function createNameSummary(combinedSummaries, name, container) {
        const nameGroup = document.createElement('div');
        nameGroup.className = 'name-group';
        
        // Name header
        const nameHeader = document.createElement('div');
        nameHeader.className = 'name-header';
        nameHeader.textContent = name;
        nameGroup.appendChild(nameHeader);
        
        // Create table for this name
        const table = document.createElement('table');
        
        // Table header
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th>Date/Time</th>
                <th>PNumber</th>
                <th>Name Total Money</th>
                <th>P Money</th>
                <th>Commission (15%)</th>
                <th>Multiple (80)</th>
                <th>Total</th>
            </tr>
        `;
        table.appendChild(thead);
        
        // Table body - one row per ledger
        const tbody = document.createElement('tbody');
        
        // Add ledger rows
        combinedSummaries[name].ledgers.forEach(ledger => {
            const commissionAmount = (ledger.nameTotalMoney * 15) / 100;
            const total = ledger.nameTotalMoney - commissionAmount - (ledger.pmoney * 80);
            
            const row = document.createElement('tr');
            row.className = 'ledger-row-detail';
            row.innerHTML = `
                <td>${ledger.date} / ${ledger.time}</td>
                <td>${ledger.pnumber || '-'}</td>
                <td>${ledger.nameTotalMoney.toLocaleString()}</td>
                <td>${ledger.pmoney.toLocaleString()}</td>
                <td>${commissionAmount.toLocaleString()}</td>
                <td>${(ledger.pmoney * 80).toLocaleString()}</td>
                <td class="${total >= 0 ? 'profit' : 'loss'}">${total.toLocaleString()}</td>
            `;
            tbody.appendChild(row);
        });
        
        // Group footer with totals
        const totalCommission = (combinedSummaries[name].totalNameMoney * 15) / 100;
        const totalResult = combinedSummaries[name].totalNameMoney - totalCommission - (combinedSummaries[name].totalPmoney * 80);
        
        const tfoot = document.createElement('tfoot');
        tfoot.innerHTML = `
            <tr class="group-footer">
                <td colspan="2">${name} Totals:</td>
                <td>${combinedSummaries[name].totalNameMoney.toLocaleString()}</td>
                <td>${combinedSummaries[name].totalPmoney.toLocaleString()}</td>
                <td>${totalCommission.toLocaleString()}</td>
                <td>${(combinedSummaries[name].totalPmoney * 80).toLocaleString()}</td>
                <td class="${totalResult >= 0 ? 'profit' : 'loss'}">${totalResult.toLocaleString()}</td>
            </tr>
        `;
        
        table.appendChild(tbody);
        table.appendChild(tfoot);
        nameGroup.appendChild(table);
        container.appendChild(nameGroup);
    }
    
    // Add grand totals to combined summary
    function addGrandTotals(combinedSummaries, container) {
        let grandTotalNameMoney = 0;
        let grandTotalPmoney = 0;
        let grandTotalCommission = 0;
        let grandTotalResult = 0;
        
        // Calculate grand totals
        for (const name in combinedSummaries) {
            grandTotalNameMoney += combinedSummaries[name].totalNameMoney;
            grandTotalPmoney += combinedSummaries[name].totalPmoney;
            
            const commission = (combinedSummaries[name].totalNameMoney * 15) / 100;
            grandTotalCommission += commission;
            
            const result = combinedSummaries[name].totalNameMoney - commission - (combinedSummaries[name].totalPmoney * 80);
            grandTotalResult += result;
        }
        
        // Create grand totals element
        const grandTotalElement = document.createElement('div');
        grandTotalElement.className = 'name-group';
        
        const grandTotalHeader = document.createElement('div');
        grandTotalHeader.className = 'name-header';
        grandTotalHeader.textContent = 'Grand Totals';
        grandTotalElement.appendChild(grandTotalHeader);
        
        const table = document.createElement('table');
        
        const tfoot = document.createElement('tfoot');
        tfoot.innerHTML = `
            <tr class="total-footer">
                <td colspan="2">TOTALS:</td>
                <td>${grandTotalNameMoney.toLocaleString()}</td>
                <td>${grandTotalPmoney.toLocaleString()}</td>
                <td>${grandTotalCommission.toLocaleString()}</td>
                <td>${(grandTotalPmoney * 80).toLocaleString()}</td>
                <td class="${grandTotalResult >= 0 ? 'profit' : 'loss'}">${grandTotalResult.toLocaleString()}</td>
            </tr>
            <tr class="total-footer">
                <td colspan="6">Overall Result:</td>
                <td class="${grandTotalResult >= 0 ? 'profit' : 'loss'}">
                    ${grandTotalResult >= 0 ? 'PROFIT' : 'LOSS'}
                </td>
            </tr>
        `;
        table.appendChild(tfoot);
        
        grandTotalElement.appendChild(table);
        container.appendChild(grandTotalElement);
    }
</script>
</body>
</html>

